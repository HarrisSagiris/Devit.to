<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Devit.to">
    
    <!-- Primary SEO Meta Tags -->
    <title>Devit.to - The Developer Community Platform</title>
    <meta name="description" content="Join Devit.to, the leading developer community platform. Share knowledge, connect with developers worldwide, discuss programming, and stay updated with the latest tech trends.">
    <meta name="keywords" content="developer community, programming forum, coding discussions, tech news, software development, web development, javascript, python, react, node.js, developer platform">
    <meta name="author" content="Devit.to Team">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph Meta Tags for Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://devit.to">
    <meta property="og:title" content="Devit.to - The Developer Community Platform">
    <meta property="og:description" content="Join Devit.to, the leading developer community platform. Share knowledge, connect with developers worldwide, and stay updated with the latest tech trends.">
    <meta property="og:image" content="https://devit.to/icons/devit-og.jpg">
    <meta property="og:site_name" content="Devit.to">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@devit_platform">
    <meta name="twitter:title" content="Devit.to - The Developer Community Platform">
    <meta name="twitter:description" content="Join Devit.to, the leading developer community platform. Share knowledge, connect with developers worldwide, and stay updated with the latest tech trends.">
    <meta name="twitter:image" content="https://devit.to/icons/devit-twitter.jpg">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://devit.to">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 2L2 7L12 12L22 7L12 2Z' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M2 17L12 22L22 17' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M2 12L12 17L22 12' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">
    
    <!-- iOS icons -->
    <link rel="apple-touch-icon" href="/icons/devit.jpg">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/devit.jpg">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/devit.jpg">
    <link rel="apple-touch-icon" sizes="167x167" href="/icons/devit.jpg">
    
    <!-- iOS splash screens -->
    <link rel="apple-touch-startup-image" href="/splash/iphone5.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/splash/iphone6.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/splash/iphoneplus.png" media="(device-width: 621px) and (device-height: 1104px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="/splash/iphonex.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="/splash/iphonexr.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/splash/iphonexsmax.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="/splash/ipad.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/splash/ipadpro1.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/splash/ipadpro2.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/splash/ipadpro3.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)">

    <!-- Preload Critical Resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" as="style">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" as="style">
    
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<style>
    /* iOS specific styles */
    * {
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
    }

    /* Prevent text size adjustment on orientation change */
    html {
        -webkit-text-size-adjust: 100%;
    }

    /* Add smooth scrolling for iOS */
    body {
        -webkit-overflow-scrolling: touch;
        padding-bottom: 85px; /* Add padding for bottom bar */
    }

    /* iOS Bottom Bar */
    .ios-bottom-bar {
        display: none; /* Hidden by default, shown only on iOS */
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 70px;
        background: var(--bg-card);
        border-top: 1px solid var(--border);
        z-index: 1000;
        padding: 10px 0;
        box-shadow: var(--shadow-lg);
    }

    @supports (-webkit-touch-callout: none) {
        .ios-bottom-bar {
            display: flex; /* Show only on iOS */
            justify-content: space-around;
            align-items: center;
            padding-bottom: 25px; /* Account for iOS home indicator */
        }
    }

    .bottom-bar-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        text-decoration: none;
        font-size: 0.75rem;
        gap: 4px;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .bottom-bar-item i {
        font-size: 1.5rem;
    }

    .bottom-bar-item:hover,
    .bottom-bar-item.active {
        color: var(--primary);
        background: var(--bg);
    }

    .bottom-bar-item.create {
        color: var(--primary);
    }

    .bottom-bar-item.create i {
        font-size: 1.75rem;
    }

    /* Theme variables - Dark theme first for default dark mode */
    :root {
        --primary: #818cf8;
        --primary-hover: #6366f1;
        --bg: #111827;
        --bg-card: #1f2937;
        --text: #f9fafb;
        --text-muted: #9ca3af;
        --border: #374151;
        --upvote: #34d399;
        --downvote: #f87171;
        --header-bg: #1f2937;
        --nav-bg: #1f2937;
        --link: #818cf8;
        --link-hover: #6366f1;
        --code-bg: #374151;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
        --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.4), 0 1px 2px -1px rgb(0 0 0 / 0.4);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.4), 0 4px 6px -4px rgb(0 0 0 / 0.4);
    }

    html[data-theme="light"] {
        --primary: #6366f1;
        --primary-hover: #4f46e5;
        --bg: #f9fafb;
        --bg-card: #ffffff;
        --text: #1f2937;
        --text-muted: #6b7280;
        --border: #e5e7eb;
        --upvote: #10b981;
        --downvote: #ef4444;
        --header-bg: #ffffff;
        --nav-bg: #ffffff;
        --link: #4f46e5;
        --link-hover: #6366f1;
        --code-bg: #f3f4f6;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    /* Theme switch styles */
    .theme-switch {
        position: relative;
        width: 60px;
        height: 30px;
        margin: 0 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .theme-switch::before {
        content: "ðŸŒž";
        font-size: 16px;
    }

    .theme-switch::after {
        content: "ðŸŒ™";
        font-size: 16px;
    }

    .theme-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--bg-card);
        border: 2px solid var(--primary);
        transition: .4s;
        border-radius: 34px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 2px;
        bottom: 2px;
        background-color: var(--primary);
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: var(--primary);
        border-color: var(--primary);
    }

    input:checked + .slider:before {
        transform: translateX(30px);
        background-color: var(--bg-card);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background-color: var(--bg);
        color: var(--text);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        line-height: 1.5;
        transition: background-color 0.3s, color 0.3s;
    }

    .ranking {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-right: 1rem;
    }

    .ranking-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
        box-shadow: var(--shadow);
    }

    .ranking-badge.gold {
        background: linear-gradient(45deg, #FFD700, #FFA500);
        color: #000;
    }

    .ranking-badge.silver {
        background: linear-gradient(45deg, #C0C0C0, #A9A9A9);
        color: #000;
    }

    .ranking-badge.bronze {
        background: linear-gradient(45deg, #CD7F32, #8B4513);
        color: #fff;
    }

    .ranking-badge i {
        margin-right: 0.375rem;
        font-size: 0.875rem;
    }

    .ranking-points {
        font-size: 0.75rem;
        color: var(--text-muted);
        background: var(--bg-card);
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        border: 1px solid var(--border);
        white-space: nowrap;
        box-shadow: var(--shadow);
    }

    .version-banner {
        background: linear-gradient(to right, var(--primary), var(--primary-hover));
        color: white;
        text-align: center;
        padding: 0.75rem;
        font-size: 0.875rem;
        font-weight: 600;
        letter-spacing: 0.025em;
    }

    .github-banner {
        background: var(--bg-card);
        border-bottom: 1px solid var(--border);
        padding: 1rem;
        text-align: center;
        font-size: 0.875rem;
        color: var(--text);
        font-weight: 500;
    }

    .github-banner a {
        color: var(--primary);
        text-decoration: none;
        font-weight: 600;
        transition: color 0.2s;
    }

    .github-banner a:hover {
        color: var(--primary-hover);
        text-decoration: underline;
    }

    .header {
        background: var(--nav-bg);
        padding: 1rem;
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: var(--shadow-lg);
        backdrop-filter: blur(8px);
        transition: all 0.3s ease;
    }

    .header-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .logo {
        font-family: 'Poppins', sans-serif;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: transform 0.2s ease;
    }

    .logo:hover {
        transform: scale(1.05);
    }

    .nav-links {
        display: flex;
        align-items: center;
        gap: 1.25rem;
    }

    .nav-links a {
        color: var(--text);
        text-decoration: none;
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
        position: relative;
    }

    .nav-links a:hover {
        color: var(--primary);
        background: var(--bg);
        transform: translateY(-1px);
    }

    .nav-links a:active {
        transform: translateY(0);
    }

    .nav-links .for-developers-btn {
        background: var(--primary);
        color: white;
        padding: 0.5rem 1rem;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .nav-links .for-developers-btn:hover {
        background: var(--primary-hover);
        color: white;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .nav-links .github-btn {
        background: #24292e;
        color: white;
        padding: 0.5rem 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .nav-links .github-btn:hover {
        background: #1a1e22;
        color: white;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .search-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
        display: flex;
        gap: 1rem;
    }

    .search-container input,
    .search-container select {
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        border: 1px solid var(--border);
        background: var(--bg-card);
        color: var(--text);
        font-size: 0.875rem;
        transition: all 0.2s;
    }

    .search-container input:focus,
    .search-container select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .search-container input {
        flex: 1;
    }

    .search-container select {
        min-width: 180px;
    }

    .feed {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0;
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 1.5rem;
    }

    .post {
        background: var(--bg-card);
        border-radius: 0;
        overflow: hidden;
        box-shadow: var(--shadow);
        transition: transform 0.2s, box-shadow 0.2s;
        width: 100%;
    }

    @media (min-width: 768px) {
        .feed {
            padding: 0 1rem;
        }

        .post {
            border-radius: 1rem;
        }
    }

    .post:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow);
    }

    .post-content-wrapper {
        display: flex;
        flex-direction: column;
        width: 100%;
    }

    @media (min-width: 768px) {
        .post-content-wrapper {
            flex-direction: row;
        }
    }

    .post-votes {
        padding: 1rem;
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        background: var(--bg);
        border-bottom: 1px solid var(--border);
        width: 100%;
    }

    @media (min-width: 768px) {
        .post-votes {
            padding: 1.5rem;
            flex-direction: column;
            min-width: 80px;
            width: auto;
            border-right: 1px solid var(--border);
            border-bottom: none;
        }
    }

    .vote-btn {
        background: transparent;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 0.5rem;
        font-size: 1.25rem;
        transition: all 0.2s;
        border-radius: 0.5rem;
    }

    .vote-btn:hover {
        background: var(--bg-card);
        color: var(--primary);
    }

    .vote-btn.active {
        color: var(--primary);
    }

    .vote-count {
        font-weight: 700;
        font-size: 1rem;
        color: var(--text);
        text-align: center;
        padding: 0.25rem;
        min-width: 2rem;
        border-radius: 0.25rem;
        background: var(--bg-card);
        transition: all 0.2s;
    }

    .post-main {
        padding: 1rem;
        flex: 1;
        width: 100%;
    }

    @media (min-width: 768px) {
        .post-main {
            padding: 1.5rem;
        }
    }

    .post-header {
        margin-bottom: 1rem;
    }

    .post-meta {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .post-title {
        font-family: 'Poppins', sans-serif;
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 0.75rem;
        line-height: 1.4;
    }

    @media (min-width: 768px) {
        .post-title {
            font-size: 1.25rem;
        }
    }

    .post-content {
        font-size: 0.9375rem;
        line-height: 1.6;
        color: var(--text);
        margin-bottom: 1.25rem;
    }

    .post-actions {
        display: flex;
        gap: 0.75rem;
        font-size: 0.875rem;
        color: var(--text-muted);
        flex-wrap: wrap;
        padding: 0 0.5rem;
    }

    .post-actions button {
        background: transparent;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.375rem;
        transition: all 0.2s;
    }

    @media (min-width: 768px) {
        .post-actions {
            padding: 0;
        }

        .post-actions button {
            padding: 0.5rem 0.75rem;
            gap: 0.5rem;
        }
    }

    .post-actions button:hover {
        background: var(--bg);
        color: var(--primary);
    }

    .comments-section {
        padding: 1rem;
        border-top: 1px solid var(--border);
        background: var(--bg);
        width: 100%;
    }

    .comment {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 0.5rem;
        background: var(--bg-card);
        border: 1px solid var(--border);
        transition: all 0.1s ease;
        box-shadow: var(--shadow-sm);
        width: 100%;
    }

    .comment:hover {
        transform: translateX(1px);
    }

    .comment-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        flex-wrap: wrap;
    }

    .comment-username {
        color: var(--primary);
        font-weight: 500;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .comment-username::before {
        content: "";
        background-image: url('/icons/icon.jpg');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        width: 0.875rem;
        height: 0.875rem;
        display: inline-block;
        border-radius: 50%;
    }

    .comment-content {
        font-size: 0.875rem;
        line-height: 1.4;
        color: var(--text);
        margin-bottom: 0.75rem;
        padding-left: 0.5rem;
        border-left: 2px solid var(--primary);
        word-break: break-word;
    }

    .comment-actions {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .comment-like-btn {
        background: transparent;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        border-radius: 1rem;
        transition: all 0.2s;
        border: 1px solid var(--border);
    }

    .comment-like-btn:hover {
        background: var(--bg);
        color: var(--primary);
        border-color: var(--primary);
    }

    .comment-like-btn.liked {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .delete-comment-btn {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text-muted);
        padding: 0.25rem 0.5rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .delete-comment-btn:hover {
        background: var(--downvote);
        color: white;
        border-color: var(--downvote);
    }

    .comment-form {
        margin: 1rem 0 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        width: 100%;
    }

    @media (min-width: 768px) {
        .comment-form {
            flex-direction: row;
            gap: 1rem;
            align-items: center;
        }
    }

    .comment-form input {
        flex: 1;
        padding: 0.75rem 1.25rem;
        border-radius: 1.25rem;
        border: 1px solid var(--border);
        background: var(--bg-card);
        color: var(--text);
        font-size: 0.875rem;
        transition: all 0.2s ease;
        width: 100%;
    }

    .comment-form input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
    }

    .comment-form input::placeholder {
        color: var(--text-muted);
    }

    .comment-form .btn {
        padding: 0.75rem 1.25rem;
        border-radius: 1.25rem;
        background: var(--primary);
        color: white;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 100px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .comment-form .btn:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        font-size: 0.9375rem;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        letter-spacing: 0.01em;
        width: 100%;
    }

    @media (min-width: 768px) {
        .btn {
            width: auto;
            padding: 0.875rem 1.75rem;
            gap: 0.625rem;
        }
    }

    .btn:hover {
        background: var(--primary-hover);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .new-post-btn {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        padding: 1rem 1.5rem;
        border-radius: 0.75rem;
        background: var(--primary);
        color: white;
        border: none;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: var(--shadow-lg);
        transition: all 0.2s;
    }

    .new-post-btn:hover {
        background: var(--primary-hover);
        transform: translateY(-2px);
    }

    .post-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .post-form {
        background: var(--bg-card);
        padding: 2.5rem;
        width: 90%;
        max-width: 800px;
        position: relative;
        box-shadow: var(--shadow-lg);
        border-radius: 1rem;
        animation: slideUp 0.3s ease-out;
    }

    .post-form input,
    .post-form select,
    .post-form textarea {
        width: 100%;
        padding: 1rem;
        margin-bottom: 1.25rem;
        border-radius: 0.75rem;
        border: 2px solid var(--border);
        background: var(--bg);
        color: var(--text);
        font-size: 1rem;
        font-family: inherit;
        transition: all 0.2s ease;
    }

    .post-form select {
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 1.25rem;
        padding-right: 2.5rem;
        cursor: pointer;
    }

    .post-form input:hover,
    .post-form select:hover,
    .post-form textarea:hover {
        border-color: var(--primary-hover);
    }

    .post-form input:focus,
    .post-form select:focus,
    .post-form textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
        transform: translateY(-1px);
    }

    .post-form textarea {
        min-height: 250px;
        resize: vertical;
        line-height: 1.6;
    }

    .footer {
        text-align: center;
        padding: 1rem;
        color: var(--text-muted);
        font-size: 0.75rem;
        background: var(--nav-bg);
        border-top: 1px solid var(--border);
        margin-top: 0;
        line-height: 1.4;
        width: 100%;
        bottom: 0;
        left: 0;
        border-radius: 1rem 1rem 0 0;
        margin-bottom: 0;
        padding-bottom: env(safe-area-inset-bottom);
    }
    /* AI Search Button Styles */
    .search-container {
        width: 100%;
        max-width: 800px;
        margin: 2rem auto;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .search-input-wrapper {
        width: 100%;
        position: relative;
    }

    #search-bar {
        width: 100%;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        border: 1px solid var(--border);
        background: var(--bg);
        color: var(--text);
        font-size: 0.875rem;
        transition: all 0.2s;
    }

    #search-bar:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .ai-toggle-wrapper {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0.5rem 0;
    }

    .ai-toggle-label {
        font-size: 0.875rem;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .ai-toggle-label i {
        color: var(--primary);
    }

    .ai-toggle {
        position: relative;
        display: inline-block;
        width: 48px;
        height: 24px;
    }

    .ai-toggle input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .ai-toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--border);
        transition: .4s;
        border-radius: 24px;
    }

    .ai-toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    .ai-toggle input:checked + .ai-toggle-slider {
        background-color: var(--primary);
    }

    .ai-toggle input:checked + .ai-toggle-slider:before {
        transform: translateX(24px);
    }

    /* AI Response Styles */
    .ai-response {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 1rem;
        padding: 1.5rem;
        margin: 1rem 0;
        box-shadow: var(--shadow);
        animation: slideUp 0.4s ease-out;
        width: 100%;
        max-width: 800px;
        margin: 1rem auto;
        display: none;
    }

    .ai-response-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border);
    }

    .ai-response-header i {
        color: var(--primary);
        font-size: 1.25rem;
    }

    .ai-response-title {
        font-weight: 600;
        color: var(--text);
        font-size: 1rem;
    }

    .ai-response-content {
        color: var(--text);
        font-size: 0.875rem;
        line-height: 1.6;
        white-space: pre-wrap;
        padding: 1rem;
        background: var(--bg);
        border-radius: 0.5rem;
    }

    .ai-response-loading {
        display: none;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        color: var(--text-muted);
        font-size: 0.875rem;
        padding: 1rem;
        background: var(--bg-card);
        border-radius: 1rem;
        margin: 0.5rem auto;
        max-width: 800px;
        box-shadow: var(--shadow);
    }

    .ai-response-loading i {
        color: var(--primary);
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }
   /* New follow button styles */
   .follow-btn {
        background: transparent;
        border: 1px solid var(--primary);
        color: var(--primary);
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
        margin-left: 0.5rem;
    }

    .follow-btn:hover {
        background: var(--primary);
        color: white;
    }

    .follow-btn.following {
        background: var(--primary);
        color: white;
    }

    .followers-count {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-left: 0.5rem;
    }

    @media (max-width: 768px) {
        .search-container {
            width: 95%;
            margin: 1rem auto;
        }

        .header-content {
            flex-direction: column;
            gap: 1rem;
            padding: 1rem 0;
        }

        .nav-links {
            flex-wrap: wrap;
            justify-content: center;
        }

        .post-form {
            width: 95%;
            margin: 1rem;
        }

        .post-content-wrapper {
            flex-direction: column;
        }

        .post-votes {
            flex-direction: row;
            justify-content: center;
            border-right: none;
            border-bottom: 1px solid var(--border);
        }

        .new-post-btn {
            bottom: 1rem;
            right: 1rem;
        }
    }

    /* Animations */
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    .post {
        animation: slideUp 0.4s ease-out;
    }

    .comment {
        animation: fadeIn 0.2s ease-out;
    }

    /* iOS Add to Home Screen Prompt */
    .ios-prompt {
        display: none;
        text-align: center;
        padding: 1rem;
        margin: 2rem auto;
        max-width: 600px;
        background: var(--bg-card);
        border-radius: 1rem;
        box-shadow: var(--shadow);
    }

    .ios-prompt h3 {
        color: var(--text);
        margin-bottom: 1rem;
    }

    .ios-prompt p {
        color: var(--text-muted);
        margin-bottom: 1rem;
    }

    .ios-prompt img {
        max-width: 300px;
        margin: 1rem auto;
        border-radius: 0.5rem;
        box-shadow: var(--shadow);
    }
</style>
<body>
    <div class="version-banner">ðŸš€ Welcome to Devit.to - The developer platform!</div>
    
    <div class="github-banner">
        ðŸŒŸ Love Devit.to? Help us make it better! Check out our <a href="https://github.com/HarrisSagiris/Devit.to" target="_blank">GitHub repository</a> and contribute to the project. Every contribution counts! 
    </div>

    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Devit.to
            </a>
            <% if (user) { %>
                <div class="nav-links">
                    <!-- Notifications Dropdown -->
                    <div class="notifications-dropdown" style="position: relative; margin-right: 1rem;">
                        <div class="notifications-trigger" onclick="toggleNotifications(this)" style="display: flex; align-items: center; cursor: pointer; padding: 0.5rem; border-radius: 0.5rem; transition: background 0.2s;">
                            <i class="fas fa-bell" style="font-size: 1.25rem; color: var(--text);"></i>
                            <% if (user.unreadNotifications && user.unreadNotifications.length > 0) { %>
                                <span class="notification-badge" style="position: absolute; top: 0; right: 0; background: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.75rem; display: flex; align-items: center; justify-content: center;">
                                    <%= user.unreadNotifications.length %>
                                </span>
                            <% } %>
                        </div>
                        <div class="notifications-content" style="position: absolute; top: 100%; right: 0; width: 300px; max-height: 400px; overflow-y: auto; background: var(--bg-card); border-radius: 0.75rem; box-shadow: var(--shadow); margin-top: 0.5rem; z-index: 100; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.2s;">
                            <div class="notifications-header" style="padding: 1rem; border-bottom: 1px solid var(--border);">
                                <h3 style="margin: 0; font-size: 1rem; color: var(--text);">Notifications</h3>
                            </div>
                            <div class="notifications-list">
                                <% if (user.notifications && user.notifications.length > 0) { %>
                                    <% user.notifications.slice(0, 10).forEach(notification => { %>
                                        <div class="notification-item" style="padding: 1rem; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s;">
                                            <div class="notification-content" style="color: var(--text);">
                                                <%= notification.content %>
                                            </div>
                                            <div class="notification-time" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                                                <%= new Date(notification.createdAt).toLocaleDateString() %>
                                            </div>
                                        </div>
                                    <% }) %>
                                <% } else { %>
                                    <div class="no-notifications" style="padding: 1rem; text-align: center; color: var(--text-muted);">
                                        No notifications yet
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Dropdown -->
                    <div class="profile-dropdown" style="position: relative;">
                        <div class="profile-trigger" onclick="toggleDropdown(this)" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 0.5rem; transition: background 0.2s;">
                            <img src="<%= user.avatar || '/icons/icon.jpg' %>" alt="Profile" class="profile-avatar" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                            <i class="fas fa-chevron-down" style="font-size: 0.75rem; color: var(--text-muted); transition: transform 0.2s;"></i>
                        </div>
                        <div class="dropdown-content" style="position: absolute; top: 100%; right: 0; min-width: 220px; background: var(--bg-card); border-radius: 0.75rem; box-shadow: var(--shadow); margin-top: 0.5rem; z-index: 100; overflow: hidden; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.2s;">
                            <div class="dropdown-header" style="padding: 1rem; background: var(--bg-card-hover);">
                                <span style="display: block; margin-bottom: 0.5rem; color: var(--text);">Welcome, <strong><%= user.username %></strong></span>
                                <div class="ranking" style="margin-top: 0.5rem;">
                                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                        <span id="ranking-badge" class="ranking-badge" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; border-radius: 1rem; font-size: 0.875rem; background: rgba(147, 51, 234, 0.1); color: #9333ea;">
                                            <i class="fas fa-bolt" style="color: #9333ea;"></i>
                                            <span id="rank-text">Loading...</span>
                                        </span>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">
                                            Dev Points: <strong id="total-points" style="color: #9333ea;">Loading...</strong>
                                            <div style="font-size: 0.7rem; margin-top: 0.25rem;">
                                                <button onclick="togglePoints(this)" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.7rem; padding: 0;">
                                                    <i class="fas fa-chevron-right"></i> Show point details
                                                </button>
                                                <div class="points-details" style="display: none; margin-top: 0.5rem;">
                                                    <div id="post-points">Posts: Loading...</div>
                                                    <div id="comment-points">Comments: Loading...</div>
                                                    <div id="reply-points">Replies: Loading...</div>
                                                    <div id="upvotes-given-points">Upvotes Given: Loading...</div>
                                                    <div id="upvotes-received-points">Upvotes Received: Loading...</div>
                                                </div>
                                            </div>
                                            <script>
                                                function togglePoints(btn) {
                                                    const details = btn.nextElementSibling;
                                                    const icon = btn.querySelector('i');
                                                    if (details.style.display === 'none') {
                                                        details.style.display = 'block';
                                                        icon.classList.replace('fa-chevron-right', 'fa-chevron-down');
                                                        btn.innerHTML = '<i class="fas fa-chevron-down"></i> Hide point details';
                                                    } else {
                                                        details.style.display = 'none';
                                                        icon.classList.replace('fa-chevron-down', 'fa-chevron-right');
                                                        btn.innerHTML = '<i class="fas fa-chevron-right"></i> Show point details';
                                                    }
                                                }

                                                // Immediately fetch stats when script loads
                                                (async function fetchInitialStats() {
                                                    try {
                                                        const response = await fetch('/api/user/stats');
                                                        if (!response.ok) throw new Error('Failed to fetch stats');
                                                        const data = await response.json();

                                                        // Calculate points
                                                        const postPoints = data.posts * 10;
                                                        const commentPoints = data.comments * 5;
                                                        const replyPoints = data.replies * 3;
                                                        const upvotePoints = data.upvotesGiven * 2;
                                                        const receivedUpvotePoints = data.upvotesReceived * 3;
                                                        const totalPoints = postPoints + commentPoints + replyPoints + upvotePoints + receivedUpvotePoints;

                                                        // Update points display
                                                        document.getElementById('post-points').textContent = `Posts: +${postPoints}`;
                                                        document.getElementById('comment-points').textContent = `Comments: +${commentPoints}`;
                                                        document.getElementById('reply-points').textContent = `Replies: +${replyPoints}`;
                                                        document.getElementById('upvotes-given-points').textContent = `Upvotes Given: +${upvotePoints}`;
                                                        document.getElementById('upvotes-received-points').textContent = `Upvotes Received: +${receivedUpvotePoints}`;
                                                        document.getElementById('total-points').textContent = totalPoints.toLocaleString();

                                                        // Calculate and update rank
                                                        let rank;
                                                        if (totalPoints >= 10000) rank = "Dev Grandmaster";
                                                        else if (totalPoints >= 5000) rank = "Dev Legend";
                                                        else if (totalPoints >= 2500) rank = "Dev Master";
                                                        else if (totalPoints >= 1000) rank = "Dev Pro";
                                                        else if (totalPoints >= 500) rank = "Dev Expert";
                                                        else if (totalPoints >= 250) rank = "Dev Enthusiast";
                                                        else if (totalPoints >= 100) rank = "Dev Rookie";
                                                        else rank = "Dev Newbie";

                                                        document.getElementById('rank-text').textContent = rank;
                                                    } catch (error) {
                                                        console.error('Error fetching stats:', error);
                                                        document.getElementById('total-points').textContent = 'Error loading stats';
                                                        document.getElementById('rank-text').textContent = 'Error';
                                                        ['post-points', 'comment-points', 'reply-points', 'upvotes-given-points', 'upvotes-received-points'].forEach(id => {
                                                            document.getElementById(id).textContent = `${id.split('-')[0]}: Error loading`;
                                                        });
                                                    }
                                                })();

                                                // Set up periodic updates
                                                setInterval(async function updateStats() {
                                                    try {
                                                        const response = await fetch('/api/user/stats');
                                                        if (!response.ok) throw new Error('Failed to fetch stats');
                                                        const data = await response.json();

                                                        // Calculate points
                                                        const postPoints = data.posts * 10;
                                                        const commentPoints = data.comments * 5;
                                                        const replyPoints = data.replies * 3;
                                                        const upvotePoints = data.upvotesGiven * 2;
                                                        const receivedUpvotePoints = data.upvotesReceived * 3;
                                                        const totalPoints = postPoints + commentPoints + replyPoints + upvotePoints + receivedUpvotePoints;

                                                        // Update points display
                                                        document.getElementById('post-points').textContent = `Posts: +${postPoints}`;
                                                        document.getElementById('comment-points').textContent = `Comments: +${commentPoints}`;
                                                        document.getElementById('reply-points').textContent = `Replies: +${replyPoints}`;
                                                        document.getElementById('upvotes-given-points').textContent = `Upvotes Given: +${upvotePoints}`;
                                                        document.getElementById('upvotes-received-points').textContent = `Upvotes Received: +${receivedUpvotePoints}`;
                                                        document.getElementById('total-points').textContent = totalPoints.toLocaleString();

                                                        // Calculate and update rank
                                                        let rank;
                                                        if (totalPoints >= 10000) rank = "Dev Grandmaster";
                                                        else if (totalPoints >= 5000) rank = "Dev Legend";
                                                        else if (totalPoints >= 2500) rank = "Dev Master";
                                                        else if (totalPoints >= 1000) rank = "Dev Pro";
                                                        else if (totalPoints >= 500) rank = "Dev Expert";
                                                        else if (totalPoints >= 250) rank = "Dev Enthusiast";
                                                        else if (totalPoints >= 100) rank = "Dev Rookie";
                                                        else rank = "Dev Newbie";

                                                        document.getElementById('rank-text').textContent = rank;
                                                    } catch (error) {
                                                        console.error('Error updating stats:', error);
                                                    }
                                                }, 30000);
                                            </script>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="dropdown-divider" style="height: 1px; background: var(--border);"></div>
                            <a href="#" id="change-username" class="dropdown-item" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; color: var(--text); text-decoration: none; transition: background 0.2s;">
                                <i class="fas fa-user-edit"></i>
                                Change Username
                            </a>
                            <a href="/my-posts" class="dropdown-item" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; color: var(--text); text-decoration: none; transition: background 0.2s;">
                                <i class="fas fa-chart-line"></i>
                                Reputation
                            </a>
                            <a href="fordevelopers.html" class="dropdown-item" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; color: var(--text); text-decoration: none; transition: background 0.2s;">
                                <i class="fas fa-info-circle"></i>
                                About us
                            </a>
                            <a href="/github" class="dropdown-item" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; color: var(--text); text-decoration: none; transition: background 0.2s;">
                                <i class="fas fa-newspaper"></i>
                                News
                            </a>
                            <a href="/my-bookmarks" class="dropdown-item" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; color: var(--text); text-decoration: none; transition: background 0.2s;">
                                <i class="fas fa-bookmark"></i>
                                My Bookmarks
                            </a>
                            <div class="dropdown-divider" style="height: 1px; background: var(--border);"></div>
                            <div class="theme-toggle-container dropdown-item" style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem;">
                                <span style="color: var(--text);">Theme:</span>
                                <label class="theme-switch" title="Switch between light and dark theme">
                                    <input type="checkbox" id="theme-toggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <a href="/logout" class="dropdown-item text-danger" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; color: var(--danger); text-decoration: none; transition: background 0.2s;">
                                <i class="fas fa-sign-out-alt"></i>
                                Logout
                            </a>
                        </div>
                    </div>
                </div>
            <% } else { %>
                <div class="nav-links">
                    <a href="/login" style="color: var(--text); text-decoration: none; padding: 0.5rem 1rem; border-radius: 0.5rem; transition: background 0.2s;">Login</a>
                    <a href="/register" style="color: var(--text); text-decoration: none; padding: 0.5rem 1rem; border-radius: 0.5rem; transition: background 0.2s;">Register</a>
                    <a href="/github" class="github-btn" style="display: flex; align-items: center; gap: 0.5rem; color: var(--text); text-decoration: none; padding: 0.5rem 1rem; border-radius: 0.5rem; transition: background 0.2s;">
                        <i class="fas fa-newspaper"></i>
                        News
                    </a>
                    
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 0.875rem; color: var(--text-muted);">Theme:</span>
                        <label class="theme-switch" title="Switch between light and dark theme">
                            <input type="checkbox" id="theme-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div style="position: absolute; top: 100%; left: 0; background: var(--bg-card); padding: 0.5rem 1rem; border-radius: 0.5rem; margin-top: 0.5rem; box-shadow: var(--shadow); font-size: 0.875rem; color: var(--text-muted); white-space: nowrap;">
                        Login/Register to access all features
                    </div>
                </div>
            <% } %>
        </div>
    </header>
    <script>
    function toggleDropdown(trigger) {
        const dropdownContent = trigger.nextElementSibling;
        if (dropdownContent.style.visibility === 'visible') {
            dropdownContent.style.opacity = '0';
            dropdownContent.style.visibility = 'hidden';
            dropdownContent.style.transform = 'translateY(-10px)';
        } else {
            dropdownContent.style.opacity = '1';
            dropdownContent.style.visibility = 'visible';
            dropdownContent.style.transform = 'translateY(0)';
        }
    }

    function toggleNotifications(trigger) {
        const notificationsContent = trigger.nextElementSibling;
        if (notificationsContent.style.visibility === 'visible') {
            notificationsContent.style.opacity = '0';
            notificationsContent.style.visibility = 'hidden';
            notificationsContent.style.transform = 'translateY(-10px)';
        } else {
            notificationsContent.style.opacity = '1';
            notificationsContent.style.visibility = 'visible';
            notificationsContent.style.transform = 'translateY(0)';
            
            // Mark notifications as read
            const badge = document.querySelector('.notification-badge');
            if (badge) {
                fetch('/api/notifications/mark-read', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        badge.remove();
                        // Update notification items to show as read
                        const notificationItems = document.querySelectorAll('.notification-item');
                        notificationItems.forEach(item => {
                            item.style.backgroundColor = 'var(--bg-card)';
                        });
                    }
                })
                .catch(error => console.error('Error marking notifications as read:', error));
            }
        }

        // Close other dropdowns when opening notifications
        const profileDropdown = document.querySelector('.dropdown-content');
        if (profileDropdown) {
            profileDropdown.style.opacity = '0';
            profileDropdown.style.visibility = 'hidden';
            profileDropdown.style.transform = 'translateY(-10px)';
        }
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (event) => {
        const notificationsDropdown = document.querySelector('.notifications-dropdown');
        const profileDropdown = document.querySelector('.profile-dropdown');
        
        if (!notificationsDropdown.contains(event.target)) {
            const notificationsContent = notificationsDropdown.querySelector('.notifications-content');
            notificationsContent.style.opacity = '0';
            notificationsContent.style.visibility = 'hidden';
            notificationsContent.style.transform = 'translateY(-10px)';
        }
        
        if (!profileDropdown.contains(event.target)) {
            const dropdownContent = profileDropdown.querySelector('.dropdown-content');
            dropdownContent.style.opacity = '0';
            dropdownContent.style.visibility = 'hidden';
            dropdownContent.style.transform = 'translateY(-10px)';
        }
    });

    // Real-time notifications using WebSocket
    const ws = new WebSocket('ws://' + window.location.host);
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.type === 'notification') {
            // Update notification badge
            const badge = document.querySelector('.notification-badge');
            if (badge) {
                const count = parseInt(badge.textContent) + 1;
                badge.textContent = count;
            } else {
                const trigger = document.querySelector('.notifications-trigger');
                const newBadge = document.createElement('span');
                newBadge.className = 'notification-badge';
                newBadge.style = 'position: absolute; top: 0; right: 0; background: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.75rem; display: flex; align-items: center; justify-content: center;';
                newBadge.textContent = '1';
                trigger.appendChild(newBadge);
            }

            // Add new notification to list
            const notificationsList = document.querySelector('.notifications-list');
            const newNotification = document.createElement('div');
            newNotification.className = 'notification-item';
            newNotification.style = 'padding: 1rem; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s; background: var(--bg-card-hover);';
            
            newNotification.innerHTML = `
                <div class="notification-content" style="color: var(--text);">
                    ${data.content}
                </div>
                <div class="notification-time" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                    ${new Date().toLocaleDateString()}
                </div>
            `;
            
            notificationsList.insertBefore(newNotification, notificationsList.firstChild);
        }
    };
    </script>
    </header>

    <div class="search-container">
        <div class="search-input-wrapper">
            <input type="text" id="search-bar" placeholder="Search posts by title, content, or category...">
            <div class="ai-toggle-wrapper">
                <label class="ai-toggle-label">
                    <i class="fas fa-robot"></i>
                    Devit.to AI
                </label>
                <label class="ai-toggle">
                    <input type="checkbox" id="ai-toggle">
                    <span class="ai-toggle-slider"></span>
                </label>
            </div>
        </div>

        <div id="ai-response" class="ai-response">
            <div class="ai-response-header">
                <i class="fas fa-robot"></i>
                <span class="ai-response-title">AI Response</span>
            </div>
            <div class="ai-response-content"></div>
        </div>

        <div id="ai-loading" class="ai-response-loading">
            <i class="fas fa-spinner"></i>
            <span>AI is thinking...</span>
        </div>
        <button class="toggle-sidebar" onclick="toggleSidebar()">
            <div class="toggle-lines">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </button>

        <div class="categories-sidebar">
            <h3 class="sidebar-title">
                <i class="fas fa-layer-group"></i>
                Categories
            </h3>
            <div class="categories-list">
                <% 
                // Initialize categories object with default values
                const categories = {
                    'all': 0, // Will be updated if posts exist
                    'General': 0,
                    'Javascript/Typescript': 0,
                    'C++': 0,
                    'Devit.to': 0,
                    'Python': 0,
                    'PHP': 0,
                    'Tech': 0,
                    'AI': 0,
                    'Java': 0,
                    'Ruby': 0,
                    'Go': 0,
                    'Rust': 0,
                    'Swift': 0,
                    'Kotlin': 0,
                    'React': 0,
                    'Vue': 0,
                    'Angular': 0,
                    'Node.js': 0,
                    'DevOps': 0,
                    'Cloud Computing': 0,
                    'Cybersecurity': 0,
                    'Blockchain': 0,
                    'Machine Learning': 0,
                    'Data Science': 0
                };

                // Update 'all' count if posts exists
                if (typeof locals.posts !== 'undefined' && Array.isArray(locals.posts)) {
                    categories.all = locals.posts.length;
                    
                    // Count posts per category
                    locals.posts.forEach(post => {
                        if (categories.hasOwnProperty(post.category)) {
                            categories[post.category]++;
                        }
                    });
                }

                // Sort categories by post count (descending)
                const sortedCategories = Object.entries(categories)
                    .sort((a, b) => b[1] - a[1]);

                // Define icon map here
                const iconMap = {
                    'General': 'fas fa-globe',
                    'Javascript/Typescript': 'fab fa-js',
                    'C++': 'fas fa-code',
                    'Devit.to': 'fas fa-gamepad',
                    'Python': 'fab fa-python',
                    'PHP': 'fab fa-php',
                    'Tech': 'fas fa-microchip',
                    'AI': 'fas fa-robot',
                    'Java': 'fab fa-java',
                    'Ruby': 'fas fa-gem',
                    'Go': 'fab fa-golang',
                    'Rust': 'fas fa-cog',
                    'Swift': 'fab fa-swift',
                    'Kotlin': 'fas fa-mobile-alt',
                    'React': 'fab fa-react',
                    'Vue': 'fab fa-vuejs',
                    'Angular': 'fab fa-angular',
                    'Node.js': 'fab fa-node-js',
                    'DevOps': 'fas fa-server',
                    'Cloud Computing': 'fas fa-cloud',
                    'Cybersecurity': 'fas fa-shield-alt',
                    'Blockchain': 'fas fa-link',
                    'Machine Learning': 'fas fa-brain',
                    'Data Science': 'fas fa-chart-bar'
                };
                %>

                <a href="javascript:void(0)" class="category-item active" data-value="" onclick="filterPosts('')">
                    <i class="fas fa-th-large"></i>
                    <span>All Categories</span>
                    <span class="post-count"><%= categories['all'] %></span>
                </a>

                <% sortedCategories.forEach(([category, count]) => { 
                    if(category !== 'all' && count > 0) { %>
                        <a href="javascript:void(0)" 
                           class="category-item" 
                           data-value="<%= category %>" 
                           onclick="filterPosts('<%= category %>')">
                            <i class="<%= iconMap[category] || 'fas fa-tag' %>"></i>
                            <span><%= category %></span>
                            <span class="post-count"><%= count %></span>
                        </a>
                    <% }
                }); %>
            </div>
        </div>

        <style>
            .toggle-sidebar {
                position: fixed;
                top: 45px;
                left: 15px;
                z-index: 1000;
                background: var(--primary);
                border: none;
                border-radius: 8px;
                width: 44px;
                height: 44px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            }

            .toggle-sidebar:hover {
                transform: scale(1.05);
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            }

            .toggle-lines {
                display: flex;
                flex-direction: column;
                gap: 5px;
                width: 24px;
            }

            .toggle-lines span {
                display: block;
                width: 100%;
                height: 2.5px;
                background: white;
                border-radius: 2px;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                transform-origin: center;
            }

            .toggle-sidebar.active .toggle-lines span:nth-child(1) {
                transform: translateY(7.5px) rotate(45deg);
            }

            .toggle-sidebar.active .toggle-lines span:nth-child(2) {
                opacity: 0;
                transform: scale(0);
            }

            .toggle-sidebar.active .toggle-lines span:nth-child(3) {
                transform: translateY(-7.5px) rotate(-45deg);
            }

            .categories-sidebar {
                position: fixed;
                left: 0;
                top: 60px;
                bottom: 0;
                width: 300px;
                background: var(--bg-card);
                border-right: 1px solid var(--border);
                padding: 2rem;
                overflow-y: auto;
                box-shadow: var(--shadow-lg);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                z-index: 100;
                transform: translateX(-100%);
            }

            .categories-sidebar.active {
                transform: translateX(0);
            }

            @media (max-width: 768px) {
                .categories-sidebar {
                    width: 100%;
                    backdrop-filter: blur(8px);
                }
            }

            .sidebar-title {
                color: var(--text);
                font-size: 1.25rem;
                font-weight: 700;
                margin-bottom: 2rem;
                padding-bottom: 1rem;
                border-bottom: 2px solid var(--border);
                display: flex;
                align-items: center;
                gap: 1rem;
            }

            .sidebar-title i {
                color: var(--primary);
                font-size: 1.5rem;
            }

            .categories-list {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }

            .category-item {
                display: flex;
                align-items: center;
                padding: 1rem 1.25rem;
                color: var(--text);
                text-decoration: none;
                border-radius: 1rem;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                font-size: 1rem;
                font-weight: 500;
                background: var(--bg);
                border: 1.5px solid var(--border);
                position: relative;
                overflow: hidden;
                backdrop-filter: blur(4px);
            }

            .category-item::before {
                content: '';
                position: absolute;
                left: 0;
                top: 0;
                height: 100%;
                width: 4px;
                background: var(--primary);
                opacity: 0;
                transition: opacity 0.3s;
            }

            .category-item i {
                width: 28px;
                text-align: center;
                font-size: 1.2rem;
                color: var(--primary);
                margin-right: 1rem;
                transition: transform 0.3s;
            }

            .category-item span {
                flex: 1;
            }

            .category-item .post-count {
                background: var(--primary);
                color: white;
                padding: 0.35rem 0.75rem;
                border-radius: 2rem;
                font-size: 0.85rem;
                min-width: 28px;
                text-align: center;
                transition: all 0.3s;
                font-weight: 600;
            }

            .category-item:hover {
                background: var(--primary-light);
                border-color: var(--primary);
                transform: translateY(-2px);
            }

            .category-item:hover::before {
                opacity: 1;
            }

            .category-item:hover i {
                transform: scale(1.15) rotate(5deg);
            }

            .category-item:hover .post-count {
                transform: scale(1.1);
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            }

            .category-item.active {
                background: var(--primary);
                color: white;
                border-color: var(--primary);
                box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.2);
            }

            .category-item.active i {
                color: white;
            }

            .category-item.active .post-count {
                background: white;
                color: var(--primary);
            }

            .categories-sidebar::-webkit-scrollbar {
                width: 8px;
            }

            .categories-sidebar::-webkit-scrollbar-track {
                background: var(--bg);
                border-radius: 4px;
            }

            .categories-sidebar::-webkit-scrollbar-thumb {
                background: var(--primary);
                border-radius: 4px;
                border: 2px solid var(--bg);
            }

            .categories-sidebar::-webkit-scrollbar-thumb:hover {
                background: var(--primary-hover);
            }

            @keyframes fadeIn {
                from { 
                    opacity: 0; 
                    transform: translateY(20px); 
                }
                to { 
                    opacity: 1; 
                    transform: translateY(0); 
                }
            }

            .category-item {
                animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
                animation-delay: calc(var(--index) * 0.08s);
                opacity: 0;
            }
        </style>

        <script>
            // Add animation delay to categories
            document.querySelectorAll('.category-item').forEach((item, index) => {
                item.style.setProperty('--index', index);
            });

            // Toggle sidebar functionality
            function toggleSidebar() {
                const sidebar = document.querySelector('.categories-sidebar');
                const toggleBtn = document.querySelector('.toggle-sidebar');
                sidebar.classList.toggle('active');
                toggleBtn.classList.toggle('active');
            }
        </script>
    <script>
        const searchBar = document.getElementById('search-bar');
        const aiToggle = document.getElementById('ai-toggle');
        const aiLoading = document.getElementById('ai-loading');
        const aiResponse = document.getElementById('ai-response');
        const aiResponseContent = aiResponse.querySelector('.ai-response-content');

        let debounceTimeout;

        searchBar.addEventListener('input', () => {
            // Clear any existing timeout
            clearTimeout(debounceTimeout);

            if (!aiToggle.checked) return;
            
            const query = searchBar.value.trim();
            if (!query) {
                aiResponse.style.display = 'none';
                aiLoading.style.display = 'none';
                return;
            }

            // Set loading state
            aiLoading.style.display = 'flex';
            aiResponse.style.display = 'none';

            // Debounce the API call by 500ms
            debounceTimeout = setTimeout(async () => {
                try {
                    const prompt = `Given this search query: "${query}", provide a helpful response that could include:
                    - Relevant technical explanations
                    - Code examples if applicable
                    - Best practices
                    - Common pitfalls to avoid
                    Please keep the response concise and focused.`;

                    const response = await fetch('https://api-inference.huggingface.co/models/Qwen/Qwen2.5-Coder-32B-Instruct', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer 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',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            inputs: prompt,
                            parameters: {
                                max_length: 500,
                                temperature: 0.7,
                                top_p: 0.95,
                                top_k: 50,
                                repetition_penalty: 1.2,
                                return_full_text: false,
                                max_new_tokens: 250,
                                do_sample: true
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error('API request failed');
                    }

                    const result = await response.json();
                    
                    // Format the response text with line breaks and proper spacing
                    const formattedText = result[0].generated_text
                        .trim()
                        .replace(/\n/g, '<br>')
                        .replace(/```([^`]+)```/g, '<pre><code>$1</code></pre>');
                    
                    aiResponseContent.innerHTML = formattedText;
                    
                    aiLoading.style.display = 'none';
                    aiResponse.style.display = 'block';

                } catch (error) {
                    console.error('Error:', error);
                    aiResponseContent.innerHTML = `
                        <div style="color: #ff4444; padding: 1rem;">
                            Sorry, there was an error processing your request. Please try again later.
                            <br><small>${error.message}</small>
                        </div>
                    `;
                    
                    aiLoading.style.display = 'none';
                    aiResponse.style.display = 'block';
                }
            }, 500);
        });

        aiToggle.addEventListener('change', () => {
            if (!aiToggle.checked) {
                aiResponse.style.display = 'none';
                aiLoading.style.display = 'none';
            } else if (searchBar.value.trim()) {
                // Trigger search if there's already text in the search bar
                searchBar.dispatchEvent(new Event('input'));
            }
        });
    </script>

    <main class="feed">
        <% posts.forEach(post => { %>
            <article class="post" id="post-<%= post._id %>">
                <div class="post-content-wrapper">
                    <div class="post-votes">
                        <button class="vote-btn upvote <%= post.upvotedBy?.includes(user?._id) ? 'active' : '' %>" data-id="<%= post._id %>">â¬†ï¸</button>
                        <span class="vote-count upvote-count"><%= post.upvotes %></span>
                        <span class="vote-count downvote-count"><%= post.downvotes %></span>
                        <button class="vote-btn downvote <%= post.downvotedBy?.includes(user?._id) ? 'active' : '' %>" data-id="<%= post._id %>">â¬‡ï¸</button>
                    </div>
                    <div class="post-main">
                        <div class="post-header">
                            <div class="post-meta">
                                Posted in <%= post.category %> by 
                                <span class="user-info">
                                    <%= post.username %> (<%= post.author ? post.author.totalUpvotes : 0 %> total upvotes)
                                    <% if (user && user.username !== post.username) { %>
                                        <button class="follow-btn <%= user.following?.includes(post.username) ? 'following' : '' %>" 
                                                data-username="<%= post.username %>">
                                            <%= user.following?.includes(post.username) ? 'Following' : 'Follow' %>
                                        </button>
                                    <% } %>
                                </span>
                                â€¢ <%= new Date(post.createdAt).toLocaleDateString() %>
                            </div>
                            <h3 class="post-title"><%= post.title %></h3>
                            <div class="post-content">
                                <% 
                                    let content = post.content;
                                    // YouTube link regex
                                    const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)(?:\S+)?/g;
                                    // GitHub link regex
                                    const githubRegex = /(?:https?:\/\/)?(?:www\.)?github\.com\/([a-zA-Z0-9_-]+)\/([a-zA-Z0-9_-]+)(?:\/)?/g;

                                    // Replace YouTube links with embeds
                                    content = content.replace(youtubeRegex, (match, videoId) => {
                                        return `
                                            <div class="youtube-embed">
                                                <div class="video-container" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; margin-bottom: 1rem;">
                                                    <iframe 
                                                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 12px;"
                                                        src="https://www.youtube.com/embed/${videoId}" 
                                                        frameborder="0" 
                                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                                        allowfullscreen>
                                                    </iframe>
                                                </div>
                                                <a href="${match}" target="_blank" rel="noopener noreferrer" class="video-link" style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: #FF0000; color: white; text-decoration: none; border-radius: 8px; font-weight: 500; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(255,0,0,0.2);">
                                                    <svg class="youtube-icon" viewBox="0 0 24 24" width="20" height="20" style="fill: currentColor;">
                                                        <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                                                    </svg>
                                                    Watch on YouTube
                                                </a>
                                            </div>
                                        `;
                                    });

                                    // Replace GitHub links with repository cards
                                    content = content.replace(githubRegex, (match, username, repo) => {
                                        // Extract repo name without trailing slash if present
                                        const cleanRepo = repo.replace(/\/$/, '');
                                        
                                        return `<div class="github-card" style="
                                            background: var(--bg-card);
                                            border-radius: 16px;
                                            padding: 1rem;
                                            margin: 1rem 0;
                                            border: 1px solid var(--border);
                                            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
                                            transition: all 0.2s ease;
                                            max-width: 400px;
                                            transform: translateY(0);
                                        " onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05)'" 
                                           onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06)'">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                                <svg style="width: 20px; height: 20px; color: var(--text-muted);" viewBox="0 0 16 16">
                                                    <path fill="currentColor" d="M2 2.5A2.5 2.5 0 014.5 0h8.75a.75.75 0 01.75.75v12.5a.75.75 0 01-.75.75h-2.5a.75.75 0 110-1.5h1.75v-2h-8a1 1 0 00-.714 1.7.75.75 0 01-1.072 1.05A2.495 2.495 0 012 11.5v-9zm10.5-1V9h-8c-.356 0-.694.074-1 .208V2.5a1 1 0 011-1h8zM5 12.25v3.25a.25.25 0 00.4.2l1.45-1.087a.25.25 0 01.3 0L8.6 15.7a.25.25 0 00.4-.2v-3.25a.25.25 0 00-.25-.25h-3.5a.25.25 0 00-.25.25z"/>
                                                </svg>
                                                <a href="https://github.com/${username}" target="_blank" style="
                                                    color: var(--primary);
                                                    text-decoration: none;
                                                    font-weight: 600;
                                                    font-size: 0.9rem;
                                                ">${username}</a>
                                                <span style="color: var(--text-muted)">/</span>
                                                <a href="${match}" target="_blank" style="
                                                    color: var(--primary);
                                                    text-decoration: none;
                                                    font-weight: 600;
                                                    font-size: 0.9rem;
                                                ">${cleanRepo}</a>
                                            </div>
                                            <p class="repo-description" style="
                                                color: var(--text);
                                                font-size: 0.875rem;
                                                margin: 0.5rem 0;
                                                line-height: 1.5;
                                            "></p>
                                            <div style="
                                                display: flex;
                                                gap: 1rem;
                                                font-size: 0.75rem;
                                                color: var(--text-muted);
                                                margin-top: 0.75rem;
                                            ">
                                                <div style="display: flex; align-items: center; gap: 0.25rem;">
                                                    <span class="repo-language-color" style="
                                                        width: 0.75rem;
                                                        height: 0.75rem;
                                                        border-radius: 50%;
                                                        display: inline-block;
                                                    "></span>
                                                    <span class="repo-language"></span>
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 0.25rem;">
                                                    <svg style="width: 14px; height: 14px;" viewBox="0 0 16 16">
                                                        <path fill="currentColor" d="M8 .25a.75.75 0 01.673.418l1.882 3.815 4.21.612a.75.75 0 01.416 1.279l-3.046 2.97.719 4.192a.75.75 0 01-1.088.791L8 12.347l-3.766 1.98a.75.75 0 01-1.088-.79l.72-4.194L.818 6.374a.75.75 0 01.416-1.28l4.21-.611L7.327.668A.75.75 0 018 .25z"/>
                                                    </svg>
                                                    <span class="stars">-</span>
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 0.25rem;">
                                                    <svg style="width: 14px; height: 14px;" viewBox="0 0 16 16">
                                                        <path fill="currentColor" d="M5 3.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm0 2.122a2.25 2.25 0 10-1.5 0v.878A2.25 2.25 0 005.75 8.5h1.5v2.128a2.251 2.251 0 101.5 0V8.5h1.5a2.25 2.25 0 002.25-2.25v-.878a2.25 2.25 0 10-1.5 0v.878a.75.75 0 01-.75.75h-4.5A.75.75 0 015 6.25v-.878zm3.75 7.378a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm3-8.75a.75.75 0 100-1.5.75.75 0 000 1.5z"/>
                                                    </svg>
                                                    <span class="forks">-</span>
                                                </div>
                                            </div>
                                            <script>
                                                fetch('https://api.github.com/repos/${username}/${cleanRepo}')
                                                    .then(response => response.json())
                                                    .then(data => {
                                                        const card = document.currentScript.parentElement;
                                                        card.querySelector('.repo-description').textContent = data.description || 'No description available';
                                                        card.querySelector('.repo-language').textContent = data.language || 'Unknown';
                                                        card.querySelector('.repo-language-color').style.backgroundColor = data.language ? '#' + Math.floor(Math.random()*16777215).toString(16) : '#888';
                                                        card.querySelector('.stars').textContent = data.stargazers_count.toLocaleString();
                                                        card.querySelector('.forks').textContent = data.forks_count.toLocaleString();
                                                    })
                                                    .catch(console.error);
                                            </script>
                                        </div>`;
                                    });
                                %>
                                <%- content %>
                            </div>
                        </div>
                        <div class="post-actions">
                            <button class="comments-toggle">ðŸ’¬ <%= post.comments.length %> Comments</button>
                            <% if (user && user.username === post.username) { %>
                                <button class="delete-btn" data-id="<%= post._id %>" onclick="deletePost('<%= post._id %>')">ðŸ—‘ï¸ Delete</button>
                            <% } %>
                            <% if (user) { %>
                                <button class="bookmark-btn <%= user.bookmarks?.includes(post._id.toString()) ? 'bookmarked' : '' %>"
                                        data-id="<%= post._id %>"
                                        onclick="toggleBookmark(this, '<%= post._id %>')">
                                    <i class="fas <%= user.bookmarks?.includes(post._id.toString()) ? 'fa-bookmark' : 'fa-bookmark-o' %>"></i>
                                    <%= user.bookmarks?.includes(post._id.toString()) ? 'Bookmarked' : 'Bookmark' %>
                                </button>
                                <script>
                                    async function toggleBookmark(button, postId) {
                                        try {
                                            const response = await fetch(`/post/${postId}/bookmark`, {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/json'
                                                }
                                            });
                                            
                                            if (response.ok) {
                                                const data = await response.json();
                                                
                                                if (data.isBookmarked) {
                                                    button.classList.add('bookmarked');
                                                    button.innerHTML = `<i class="fas fa-bookmark"></i> Bookmarked`;
                                                    button.style.color = '#28a745';
                                                    button.style.background = '#e6f4ea';
                                                    
                                                    const toast = document.createElement('div');
                                                    toast.className = 'toast success';
                                                    toast.textContent = data.message;
                                                    document.body.appendChild(toast);
                                                    setTimeout(() => toast.remove(), 3000);

                                                    // Check if we're on bookmarks page and refresh if last bookmark removed
                                                    if (window.location.pathname === '/my-bookmarks') {
                                                        location.reload();
                                                    }
                                                    
                                                } else {
                                                    button.classList.remove('bookmarked');
                                                    button.innerHTML = `<i class="fas fa-bookmark-o"></i> Bookmark`;
                                                    button.style.color = '';
                                                    button.style.background = '';
                                                    
                                                    const toast = document.createElement('div');
                                                    toast.className = 'toast info';
                                                    toast.textContent = data.message;
                                                    document.body.appendChild(toast);
                                                    setTimeout(() => toast.remove(), 3000);

                                                    // Check if we're on bookmarks page and refresh if last bookmark removed
                                                    if (window.location.pathname === '/my-bookmarks') {
                                                        location.reload();
                                                    }
                                                }
                                            } else {
                                                const data = await response.json();
                                                const toast = document.createElement('div');
                                                toast.className = 'toast error';
                                                toast.textContent = data.error || 'Failed to toggle bookmark';
                                                document.body.appendChild(toast);
                                                setTimeout(() => toast.remove(), 3000);
                                            }
                                        } catch (error) {
                                            console.error('Error toggling bookmark:', error);
                                            const toast = document.createElement('div');
                                            toast.className = 'toast error';
                                            toast.textContent = 'Error toggling bookmark';
                                            document.body.appendChild(toast);
                                            setTimeout(() => toast.remove(), 3000);
                                        }
                                    }
                                </script>
                            <% } %>
                        </div>
                    </div>
                </div>
                <div class="comments-section">
                    <% if (user) { %>
                        <form class="comment-form" data-id="<%= post._id %>">
                            <input type="text" name="content" placeholder="Add a comment..." required>
                            <input type="hidden" name="username" value="<%= user.username %>">
                            <input type="hidden" name="authorId" value="<%= user._id %>">
                            <button type="submit" class="btn">Comment</button>
                        </form>
                    <% } %>
                    <div class="comments" id="comments-<%= post._id %>">
                        <% post.comments.forEach(comment => { %>
                            <div class="comment" id="comment-<%= comment._id %>">
                                <div class="comment-header">
                                    <span class="comment-username">
                                        <%= comment.username %>
                                        <span class="user-rank" style="display: inline-flex; align-items: center; margin-left: 8px;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: #9c6ade;">
                                                <path d="M13 10V3L4 14h7v7l9-11h-7z" stroke="currentColor" fill="currentColor"/>
                                            </svg>
                                            <span style="color: #9c6ade; font-size: 0.8em; margin-left: 4px;"><%= comment.authorId ? comment.authorId.points : 0 %></span>
                                        </span>
                                    </span>
                                </div>
                                <div class="comment-content">
                                    <%= comment.content %>
                                </div>
                                <div class="comment-actions">
                                    <button class="comment-like-btn <%= comment.likedBy?.includes(user?.username) ? 'liked' : '' %>"
                                            data-comment-id="<%= comment._id %>"
                                            data-post-id="<%= post._id %>"
                                            onclick="likeComment(this, '<%= comment._id %>', '<%= post._id %>')"
                                            <%= !user ? 'disabled' : '' %>>
                                        â™¥ <span class="like-count"><%= comment.likes || 0 %></span>
                                    </button>
                                    <script>
                                        async function likeComment(button, commentId, postId) {
                                            try {
                                                const response = await fetch(`/api/posts/${postId}/comments/${commentId}/like`, {
                                                    method: 'POST',
                                                    headers: {
                                                        'Content-Type': 'application/json'
                                                    }
                                                });

                                                if (response.ok) {
                                                    const data = await response.json();
                                                    const likeCount = button.querySelector('.like-count');
                                                    likeCount.textContent = data.likes;
                                                    
                                                    if (data.liked) {
                                                        button.classList.add('liked');
                                                    } else {
                                                        button.classList.remove('liked');
                                                    }
                                                } else {
                                                    const data = await response.json();
                                                    const toast = document.createElement('div');
                                                    toast.className = 'toast error';
                                                    toast.textContent = data.error || 'Failed to like comment';
                                                    document.body.appendChild(toast);
                                                    setTimeout(() => toast.remove(), 3000);
                                                }
                                            } catch (error) {
                                                console.error('Error liking comment:', error);
                                                const toast = document.createElement('div');
                                                toast.className = 'toast error';
                                                toast.textContent = 'Error liking comment';
                                                document.body.appendChild(toast);
                                                setTimeout(() => toast.remove(), 3000);
                                            }
                                        }
                                    </script>
                                    <% if (user) { %>
                                        <button class="comment-reply-btn"
                                                onclick="toggleReplyForm('<%= comment._id %>', '<%= comment.username %>')"
                                                style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;">
                                            ðŸ’¬ Reply
                                        </button>
                                    <% } %>
                                    <% if (user && user.username === comment.username) { %>
                                        <button class="delete-comment-btn" data-post-id="<%= post._id %>" data-comment-id="<%= comment._id %>">Delete</button>
                                    <% } %>
                                </div>
                                <div class="reply-form-container" id="reply-form-<%= comment._id %>" style="display: none; margin: 10px 0 10px 20px; width: 100%; max-width: 100%;">
                                    <form class="reply-form" data-comment-id="<%= comment._id %>" data-post-id="<%= post._id %>" style="width: 100%;">
                                        <div class="reply-header" style="color: var(--text-muted); font-size: 0.9em; margin-bottom: 5px;">
                                            Replying to @<%= comment.username %>
                                        </div>
                                        <div style="display: flex; flex-direction: column; gap: 8px; width: 100%;">
                                            <input type="text" 
                                                   name="content" 
                                                   placeholder="Write your reply..." 
                                                   required
                                                   style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); box-sizing: border-box;">
                                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                                <button type="submit" 
                                                        class="btn"
                                                        style="flex: 1; min-width: 80px; padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">
                                                    Reply
                                                </button>
                                                <button type="button" 
                                                        class="btn cancel-reply"
                                                        onclick="toggleReplyForm('<%= comment._id %>')"
                                                        style="flex: 1; min-width: 80px; padding: 8px 16px; background: var(--bg); color: var(--text-muted); border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">
                                                    Cancel
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="replies" id="replies-<%= comment._id %>">
                                    <% if (comment.replies && comment.replies.length > 0) { %>
                                        <% comment.replies.forEach(reply => { %>
                                            <div class="reply" id="reply-<%= reply._id %>" style="margin: 10px 0 10px 20px; padding-left: 10px; border-left: 2px solid var(--border); width: calc(100% - 30px); box-sizing: border-box;">
                                                <div class="reply-header">
                                                    <span class="reply-username" style="font-weight: 500; color: var(--text);">
                                                        <%= reply.username %>
                                                        <span class="user-rank" style="display: inline-flex; align-items: center; margin-left: 8px;">
                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: #9c6ade;">
                                                                <path d="M13 10V3L4 14h7v7l9-11h-7z" stroke="currentColor" fill="currentColor"/>
                                                            </svg>
                                                            <span style="color: #9c6ade; font-size: 0.8em; margin-left: 4px;"><%= reply.authorId ? reply.authorId.points : 0 %></span>
                                                        </span>
                                                    </span>
                                                </div>
                                                <div class="reply-content" style="margin: 4px 0; color: var(--text); word-wrap: break-word;">
                                                    <%= reply.content %>
                                                </div>
                                                <div class="reply-actions">
                                                    <button class="reply-upvote-btn <%= reply.likedBy?.includes(user?.username) ? 'upvoted' : '' %>"
                                                            onclick="upvoteReply(this, '<%= post._id %>', '<%= comment._id %>', '<%= reply._id %>')"
                                                            <%= !user ? 'disabled' : '' %>
                                                            style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;">
                                                        â¬†ï¸ <span class="upvote-count"><%= reply.likes || 0 %></span>
                                                    </button>
                                                    <% if (user && user.username === reply.username) { %>
                                                        <button class="delete-reply-btn" 
                                                                data-post-id="<%= post._id %>" 
                                                                data-comment-id="<%= comment._id %>"
                                                                data-reply-id="<%= reply._id %>"
                                                                style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 0.8em; padding: 2px 4px;">
                                                            Delete
                                                        </button>
                                                    <% } %>
                                                </div>
                                            </div>
                                            <script>
                                            async function upvoteReply(button, postId, commentId, replyId) {
                                                try {
                                                    const response = await fetch(`/api/posts/${postId}/comments/${commentId}/replies/${replyId}/like`, {
                                                        method: 'POST',
                                                        headers: {
                                                            'Content-Type': 'application/json'
                                                        }
                                                    });

                                                    if (response.ok) {
                                                        const data = await response.json();
                                                        const upvoteCount = button.querySelector('.upvote-count');
                                                        upvoteCount.textContent = data.likes;
                                                        
                                                        if (data.isLiked) {
                                                            button.classList.add('upvoted');
                                                        } else {
                                                            button.classList.remove('upvoted');
                                                        }
                                                    }
                                                } catch (error) {
                                                    console.error('Error upvoting reply:', error);
                                                }
                                            }
                                            </script>
                                        <% }) %>
                                    <% } %>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                </div>
            </article>
        <% }) %>
    </main>

    <script>
    function toggleReplyForm(commentId, username) {
        const replyForm = document.getElementById(`reply-form-${commentId}`);
        if (replyForm) {
            replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
            if (replyForm.style.display === 'block') {
                const input = replyForm.querySelector('input[name="content"]');
                if (input) {
                    input.focus();
                }
            }
        }
    }

    document.querySelectorAll('.reply-form').forEach(form => {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const commentId = form.dataset.commentId;
            const postId = form.dataset.postId;
            const content = form.querySelector('input[name="content"]').value;

            try {
                const response = await fetch(`/api/posts/${postId}/comments/${commentId}/replies`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    const data = await response.json();
                    const repliesContainer = document.getElementById(`replies-${commentId}`);
                    
                    // Create new reply element
                    const replyDiv = document.createElement('div');
                    replyDiv.className = 'reply';
                    replyDiv.id = `reply-${data.comment.replies[data.comment.replies.length-1]._id}`;
                    replyDiv.style = 'margin: 10px 0 10px 20px; padding-left: 10px; border-left: 2px solid var(--border); width: calc(100% - 30px); box-sizing: border-box;';
                    
                    // Add reply content with rank
                    replyDiv.innerHTML = `
                        <div class="reply-header">
                            <span class="reply-username" style="font-weight: 500; color: var(--text);">
                                ${data.comment.replies[data.comment.replies.length-1].username}
                                <span class="user-rank" style="display: inline-flex; align-items: center; margin-left: 8px;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: #9c6ade;">
                                        <path d="M13 10V3L4 14h7v7l9-11h-7z" stroke="currentColor" fill="currentColor"/>
                                    </svg>
                                    <span style="color: #9c6ade; font-size: 0.8em; margin-left: 4px;">${data.comment.replies[data.comment.replies.length-1].authorId ? data.comment.replies[data.comment.replies.length-1].authorId.points : 0}</span>
                                </span>
                            </span>
                        </div>
                        <div class="reply-content" style="margin: 4px 0; color: var(--text); word-wrap: break-word;">
                            ${data.comment.replies[data.comment.replies.length-1].content}
                        </div>
                    `;
                    
                    repliesContainer.appendChild(replyDiv);
                    form.reset();
                    toggleReplyForm(commentId);

                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to post reply');
                }
            } catch (error) {
                console.error('Error posting reply:', error);
                alert('Error posting reply');
            }
        });
    });
    </script>

    <% if (user) { %>
        <button class="new-post-btn" id="new-post-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            New Post
        </button>
        
        <div class="post-modal" id="post-modal">
            <form class="post-form" id="new-post-form">
                <input type="text" name="title" placeholder="Post title" required>
                <select name="category" required>
                    <option value="General">General</option>
                    <option value="Javascript/Typescript">Javascript/Typescript</option>
                    <option value="C++">C++</option>
                    <option value="Devit.to">Devit.to</option>
                    <option value="Python">Python</option>
                    <option value="PHP">PHP</option>
                    <option value="Tech">Tech</option>
                    <option value="AI">AI</option>
                    <option value="Java">Java</option>
                    <option value="Ruby">Ruby</option>
                    <option value="Go">Go</option>
                    <option value="Rust">Rust</option>
                    <option value="Swift">Swift</option>
                    <option value="Kotlin">Kotlin</option>
                    <option value="React">React</option>
                    <option value="Vue">Vue</option>
                    <option value="Angular">Angular</option>
                    <option value="Node.js">Node.js</option>
                    <option value="DevOps">DevOps</option>
                    <option value="Cloud Computing">Cloud Computing</option>
                    <option value="Cybersecurity">Cybersecurity</option>
                    <option value="Blockchain">Blockchain</option>
                    <option value="Machine Learning">Machine Learning</option>
                    <option value="Data Science">Data Science</option>
                </select>
                <textarea name="content" placeholder="Describe your post..." required></textarea>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn" id="cancel-post" style="background: var(--bg); color: var(--text-muted); border: 1px solid var(--border); padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s;">Cancel</button>
                    <button type="submit" class="btn">Post</button>
                </div>
            </form>
        </div>
    <% } %>
    <div id="ios-prompt" class="ios-prompt" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--bg-card); padding: 1rem; border-radius: 1rem; box-shadow: var(--shadow-lg); width: 90%; max-width: 400px; z-index: 999;">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="flex-shrink: 0;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 15V3M12 15L8 11M12 15L16 11M3 15V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <div>
                <p style="margin: 0; color: var(--text); font-weight: 500;">Add to Home Screen</p>
                <p style="margin: 0; font-size: 0.875rem; color: var(--text-muted);">Install Devit.to for the best experience</p>
            </div>
            <button id="close-ios-prompt" style="margin-left: auto; background: none; border: none; padding: 0.5rem; cursor: pointer; color: var(--text-muted);">âœ•</button>
        </div>
    </div>

    <script>
        // Check if the device is iOS and the app is not already installed
        let isIos = () => {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }

        let isInStandaloneMode = () => {
            return ('standalone' in window.navigator) && (window.navigator.standalone);
        }

        // Show prompt only on iOS devices when not in standalone mode
        if (isIos() && !isInStandaloneMode()) {
            // Show the prompt after a delay
            setTimeout(() => {
                document.getElementById('ios-prompt').style.display = 'block';
            }, 2000);

            // Handle close button
            document.getElementById('close-ios-prompt').addEventListener('click', () => {
                document.getElementById('ios-prompt').style.display = 'none';
                // Store in localStorage that user has dismissed the prompt
                localStorage.setItem('ios-prompt-dismissed', 'true');
            });
        }
    </script>

    <footer class="footer">
        <p>&copy; 2025 DEVIT.TO. All rights reserved.</p>
        <p>Licensed under @devharris</p>
    </footer>

    <script>
        $(document).ready(function() {
            // Theme switching functionality
            const themeToggle = $('#theme-toggle');
            const currentTheme = localStorage.getItem('theme') || 'light';
            
            document.documentElement.setAttribute('data-theme', currentTheme);
            themeToggle.prop('checked', currentTheme === 'dark');

            themeToggle.on('change', function() {
                const newTheme = this.checked ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
            });

            // Follow button functionality
            $(document).on('click', '.follow-btn', function() {
                if (!currentUser) {
                    alert('Please login to follow users');
                    return;
                }

                const btn = $(this);
                const username = btn.data('username');

                $.ajax({
                    url: '/api/follow',
                    method: 'POST',
                    data: JSON.stringify({ username }),
                    contentType: 'application/json',
                    success: function(response) {
                        if (response.success) {
                            // Update all instances of this user's follow button
                            $(`.follow-btn[data-username="${username}"]`).each(function() {
                                const followBtn = $(this);
                                if (response.isFollowing) {
                                    followBtn.addClass('following').text('Following');
                                } else {
                                    followBtn.removeClass('following').text('Follow');
                                }
                            });

                            // Update all instances of this user's followers count
                            const newCount = response.followersCount;
                            $(`.user-info:contains("${username}") .followers-count`).text(`(${newCount} followers)`);
                            $(`.comment-username:contains("${username}") .followers-count`).text(`(${newCount} followers)`);
                        }
                    },
                    error: function(err) {
                        alert('Error updating follow status');
                    }
                });
            });

            // All JavaScript functionality remains the same
            const postModal = $('#post-modal');
            const newPostBtn = $('#new-post-btn');
            const cancelPostBtn = $('#cancel-post');
            const currentUser = '<%= user ? user.username : "" %>';

            // Username change functionality
            $('#change-username').on('click', function(e) {
                e.preventDefault();
                
                // Create and show modal
                const modal = $(`
                    <div class="username-modal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); justify-content: center; align-items: center; z-index: 1000;">
                        <div class="username-form" style="background: var(--bg-card); padding: 2rem; border-radius: 1rem; width: 90%; max-width: 400px; box-shadow: var(--shadow-lg);">
                            <h3 style="margin-bottom: 1rem; color: var(--text);">Change Username</h3>
                            <input type="text" id="new-username-input" placeholder="Enter new username" style="width: 100%; padding: 0.75rem 1rem; margin-bottom: 1rem; border-radius: 0.5rem; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
                            <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                                <button class="cancel-username-btn btn" style="background: var(--bg); color: var(--text-muted); border: 1px solid var(--border); padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s;">Cancel</button>
                                <button class="submit-username-btn btn">Update Username</button>
                            </div>
                        </div>
                    </div>
                `).appendTo('body');

                // Handle cancel
                modal.find('.cancel-username-btn').on('click', function() {
                    modal.remove();
                });

                // Handle submit
                modal.find('.submit-username-btn').on('click', function() {
                    const newUsername = modal.find('#new-username-input').val();
                    if (newUsername) {
                        $.ajax({
                            url: '/change-username',
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({ newUsername }),
                            success: function(response) {
                                if (response.success) {
                                    const alert = $(`
                                        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                                                    background: var(--bg-card); padding: 2rem; border-radius: 1rem;
                                                    box-shadow: var(--shadow-lg); z-index: 2000;
                                                    text-align: center; min-width: 300px;">
                                            <h4 style="margin-bottom: 1rem; color: var(--text);">Username Updated!</h4>
                                            <p style="margin-bottom: 1rem; color: var(--text-muted);">Refreshing page to see changes...</p>
                                            <div class="loading-dots">
                                                <span style="animation: pulse 1s infinite">.</span>
                                                <span style="animation: pulse 1s infinite .2s">.</span>
                                                <span style="animation: pulse 1s infinite .4s">.</span>
                                            </div>
                                        </div>
                                    `).appendTo('body');

                                    modal.remove();
                                    setTimeout(() => {
                                        alert.remove();
                                        location.reload();
                                    }, 2000);
                                } else {
                                    const errorAlert = $(`
                                        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                                                    background: var(--bg-card); padding: 2rem; border-radius: 1rem;
                                                    box-shadow: var(--shadow-lg); z-index: 2000;
                                                    text-align: center; min-width: 300px;">
                                            <h4 style="margin-bottom: 1rem; color: var(--error);">Error</h4>
                                            <p style="margin-bottom: 1.5rem; color: var(--text-muted);">${response.message || 'Username already taken'}</p>
                                            <button class="btn" style="background: var(--error); color: white; border: none; 
                                                                      padding: 0.5rem 1.5rem; border-radius: 0.5rem; 
                                                                      cursor: pointer;">OK</button>
                                        </div>
                                    `).appendTo('body');

                                    errorAlert.find('button').on('click', function() {
                                        errorAlert.remove();
                                    });

                                    setTimeout(() => {
                                        errorAlert.fadeOut(300, function() {
                                            $(this).remove();
                                        });
                                    }, 3000);
                                }
                            },
                            error: function() {
                                alert('Error updating username');
                            }
                        });
                    }
                });
            });

            newPostBtn.on('click', function() {
                postModal.css('display', 'flex');
            });

            cancelPostBtn.on('click', function() {
                postModal.hide();
                $('#new-post-form')[0].reset();
            });

            $(window).on('click', function(e) {
                if (e.target === postModal[0]) {
                    postModal.hide();
                    $('#new-post-form')[0].reset();
                }
            });

            // Comment like functionality
            $(document).on('click', '.comment-like-btn', function() {
                if (!currentUser) {
                    alert('Please login to like comments');
                    return;
                }
                
                const btn = $(this);
                const commentId = btn.data('comment-id');
                const postId = btn.data('post-id');
                
                $.ajax({
                    url: `/api/posts/${postId}/comments/${commentId}/like`,
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    success: function(response) {
                        if (response.success) {
                            const likeCount = btn.find('.like-count');
                            likeCount.text(response.likes);
                            if (response.isLiked) {
                                btn.addClass('liked');
                            } else {
                                btn.removeClass('liked');
                            }
                        }
                    },
                    error: function(err) {
                        if (err.status === 401) {
                            alert('Please login to like comments');
                        } else {
                            alert('Unable to like comment. Please try again later.');
                        }
                    }
                });
            });

            // Delete comment functionality
            $(document).on('click', '.delete-comment-btn', function() {
                const postId = $(this).data('post-id');
                const commentId = $(this).data('comment-id');
                
                if (confirm('Are you sure you want to delete this comment?')) {
                    $.ajax({
                        url: `/api/posts/${postId}/comments/${commentId}`,
                        method: 'DELETE',
                        success: function(response) {
                            $(`#comment-${commentId}`).fadeOut(400, function() {
                                $(this).remove();
                            });
                        },
                        error: function(err) {
                            alert('Unable to delete comment. Please try again later.');
                        }
                    });
                }
            });

            // New post submission
            $('#new-post-form').on('submit', function(e) {
                e.preventDefault();
                $.ajax({
                    url: '/post',
                    method: 'POST',
                    data: $(this).serialize(),
                    success: function(response) {
                        location.reload();
                    },
                    error: function(err) {
                        alert('Error posting review');
                    }
                });
            });

            // Delete post
            $('.delete-btn').on('click', function(e) {
                e.preventDefault(); // Prevent any default behavior
                
                if (confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
                    const postId = $(this).data('id');
                    const postElement = $(`#post-${postId}`);
                    
                    // First check if post exists
                    if (!postElement.length) {
                        const errorMessage = $('<div class="alert alert-error">Post not found. The page will refresh.</div>')
                            .hide()
                            .insertBefore('.feed')
                            .fadeIn(400);
                            
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                        return;
                    }
                    
                    $.ajax({
                        url: `/post/${postId}`,
                        method: 'DELETE',
                        success: function(response) {
                            // Fade out and remove the post
                            postElement.fadeOut(400, function() {
                                $(this).remove();
                                
                                // Show success message
                                const successMessage = $('<div class="alert alert-success">Post deleted successfully</div>')
                                    .hide()
                                    .insertBefore('.feed')
                                    .fadeIn(400);
                                    
                                // Remove success message after 3 seconds
                                setTimeout(() => {
                                    successMessage.fadeOut(400, function() {
                                        $(this).remove();
                                    });
                                }, 3000);
                            });
                        },
                        error: function(xhr) {
                            let errorMsg = 'Failed to delete post. ';
                            
                            switch(xhr.status) {
                                case 401:
                                    errorMsg += 'Please login to delete posts.';
                                    break;
                                case 403:
                                    errorMsg += 'You do not have permission to delete this post.';
                                    break;
                                case 404:
                                    errorMsg += 'Post not found.';
                                    location.reload(); // Immediately refresh if post not found
                                    break;
                                default:
                                    errorMsg += 'An unexpected error occurred. Please try again later.';
                            }
                            
                            // Show error message
                            const errorMessage = $('<div class="alert alert-error">' + errorMsg + '</div>')
                                .hide()
                                .insertBefore('.feed')
                                .fadeIn(400);
                                
                            setTimeout(() => {
                                errorMessage.fadeOut(400, function() {
                                    $(this).remove();
                                });
                            }, 3000);
                        }
                    });
                }
            });

            // Updated voting system with separate counts
            $('.vote-btn').on('click', function() {
                if (!currentUser) {
                    const loginMessage = $('<div class="alert alert-warning" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; background: var(--bg-card); color: var(--text); padding: 1rem; border-radius: 0.5rem; box-shadow: var(--shadow-lg); border: 1px solid var(--border); font-size: 0.875rem;">Please login to vote</div>')
                        .hide()
                        .appendTo('body')
                        .fadeIn(400);
                        
                    setTimeout(() => {
                        loginMessage.fadeOut(400, function() {
                            $(this).remove();
                        });
                    }, 3000);
                    return;
                }

                const btn = $(this);
                const postId = btn.data('id');
                const isUpvote = btn.hasClass('upvote');
                const voteType = isUpvote ? 'upvote' : 'downvote';
                const postContainer = btn.closest('.post');
                const upvoteCount = postContainer.find('.upvote-count');
                const downvoteCount = postContainer.find('.downvote-count');

                $.ajax({
                    url: `/post/${postId}/${voteType}`,
                    method: 'POST',
                    success: function(response) {
                        // Update vote counts with animation
                        upvoteCount.text(response.upvotes);
                        downvoteCount.text(response.downvotes);
                        
                        // Trigger animation by removing and re-adding class
                        if (isUpvote) {
                            upvoteCount.removeClass('upvote-count').addClass('upvote-count');
                        } else {
                            downvoteCount.removeClass('downvote-count').addClass('downvote-count');
                        }
                        
                        // Update button states
                        const upvoteBtn = postContainer.find('.upvote');
                        const downvoteBtn = postContainer.find('.downvote');
                        
                        upvoteBtn.removeClass('active');
                        downvoteBtn.removeClass('active');
                        
                        if (response.userVote === 'upvote') {
                            upvoteBtn.addClass('active');
                        } else if (response.userVote === 'downvote') {
                            downvoteBtn.addClass('active');
                        }
                    },
                    error: function() {
                        alert('Please login to vote');
                    }
                });
            });

            // Comment submission
            $('.comment-form').on('submit', function(e) {
                e.preventDefault();
                const postId = $(this).data('id');
                const form = $(this);
                const content = form.find('input[name="content"]').val();
                const username = form.find('input[name="username"]').val();

                $.ajax({
                    url: `/post/${postId}/comment`,
                    method: 'POST',
                    data: {
                        content: content,
                        username: username
                    },
                    success: function(response) {
                        const commentHtml = `
                            <div class="comment" id="comment-${response.commentId}">
                                <div class="comment-header">
                                    <span class="comment-username">${username}</span>
                                </div>
                                <div class="comment-content">
                                    ${content}
                                </div>
                                <div class="comment-actions">
                                    <button class="comment-like-btn" data-comment-id="${response.commentId}" data-post-id="${postId}">
                                        â™¥ <span class="like-count">0</span>
                                    </button>
                                    <button class="delete-comment-btn" data-post-id="${postId}" data-comment-id="${response.commentId}">Delete</button>
                                </div>
                            </div>
                        `;
                        $(`#comments-${postId}`).append(commentHtml);
                        form[0].reset();
                    },
                    error: function() {
                        alert('Error posting comment');
                    }
                });
            });

            // Search functionality with debouncing
            let searchTimeout;
            $('#search-bar, #search-category').on('input change', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(function() {
                    const query = $('#search-bar').val().toLowerCase();
                    const category = $('#search-category').val();
                    
                    $('.post').each(function() {
                        const post = $(this);
                        const title = post.find('.post-title').text().toLowerCase();
                        const content = post.find('.post-content').text().toLowerCase();
                        const postCategory = post.find('.post-meta').text().split('|')[0].trim();
                        
                        const matchesQuery = !query || title.includes(query) || content.includes(query);
                        const matchesCategory = !category || postCategory === category;
                        
                        if (matchesQuery && matchesCategory) {
                            post.show();
                        } else {
                            post.hide();
                        }
                    });
                    
                    // Show message if no results found
                    const visiblePosts = $('.post:visible').length;
                    if (visiblePosts === 0) {
                        if ($('.no-results').length === 0) {
                            $('.feed').append('<p class="no-results">No posts found matching your search criteria.</p>');
                        }
                    } else {
                        $('.no-results').remove();
                    }
                }, 300);
            });
        });
    </script>
</body>
</html>
